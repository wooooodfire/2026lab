<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab遊 - 早餐點餐</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .active-tab { border-bottom: 4px solid #16a34a; color: #16a34a; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .loading-spinner { width: 48px; height: 48px; border: 4px solid #e5e7eb; border-top-color: #16a34a; border-radius: 9999px; animation: spin 0.9s linear infinite; }
        .loading-spinner-sm { width: 24px; height: 24px; border-width: 3px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-24 font-sans text-gray-900">
    <div class="max-w-md mx-auto">
        <div class="bg-green-600 p-8 text-white rounded-b-[2.5rem] shadow-lg mb-4">
            <h1 class="text-2xl font-black italic">Lab遊 - 早餐點餐</h1>
        </div>

        <div class="px-6 mb-2">
            <label class="block text-[10px] font-bold text-gray-400 mb-1 ml-1 tracking-widest uppercase">Your Name</label>
            <input type="text" id="userName" oninput="handleNameChange()" class="w-full bg-white border-2 border-gray-100 shadow-sm p-4 rounded-2xl outline-none focus:border-green-500 transition-all text-lg font-bold" placeholder="請輸入姓名">
        </div>

        <div class="flex px-6 mb-6 text-center font-bold text-gray-400 border-b">
            <div id="tabOrder" onclick="switchTab('order')" class="flex-1 py-3 cursor-pointer active-tab">我要點餐</div>
            <div id="tabHistory" onclick="switchTab('history')" class="flex-1 py-3 cursor-pointer">我的紀錄</div>
        </div>

        <div id="sectionOrder" class="px-6 space-y-4">
            <div class="bg-white p-2 rounded-xl border flex items-center shadow-sm">
                <span class="px-3 text-gray-400 text-sm font-bold">預定日期</span>
                <select id="orderDate" class="flex-1 bg-transparent p-2 outline-none font-bold text-green-700">
                    <option value="1/28">1月28日 (三)</option>
                    <option value="1/29">1月29日 (四)</option>
                </select>
            </div>
            <div id="menuContainer" class="space-y-6 max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar"></div>
        </div>

        <div id="sectionHistory" class="px-6 hidden animate-in fade-in duration-300">
            <div id="myHistoryList" class="space-y-6"></div>
        </div>

        <div id="footerBar" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/90 backdrop-blur-md border-t p-4 flex justify-between items-center shadow-[0_-10px_20px_rgba(0,0,0,0.05)] z-40">
            <div>
                <span class="text-[10px] text-gray-400 block font-black uppercase tracking-tighter">Current Total</span>
                <span class="text-2xl font-black text-green-600">$<span id="totalPrice">0</span></span>
            </div>
            <button onclick="showConfirm()" class="bg-green-600 text-white px-10 py-4 rounded-2xl font-bold shadow-lg shadow-green-200 active:scale-95 transition-all">確認品項</button>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-6 z-50">
        <div class="bg-white w-full rounded-[2.5rem] p-8 shadow-2xl transform transition-all">
            <div class="text-center mb-6">
                <div class="inline-block bg-green-50 text-green-600 text-xs font-black px-3 py-1 rounded-full mb-2 uppercase tracking-widest">Final Review</div>
                <h2 class="text-2xl font-black text-gray-800">最後確認點餐內容</h2>
            </div>
            
            <div class="space-y-4 mb-6">
                <div class="flex justify-between items-center bg-orange-50 p-4 rounded-2xl border border-orange-100">
                    <span class="text-orange-600 font-bold">預定用餐日期</span>
                    <span id="confirmDate" class="text-xl font-black text-orange-700 underline underline-offset-4"></span>
                </div>
                <div id="confirmList" class="space-y-2 text-gray-600 border-y border-gray-100 py-4 max-h-40 overflow-y-auto custom-scrollbar"></div>
            </div>

            <div class="flex flex-col space-y-3">
                <button onclick="finalSubmit()" id="finalBtn" class="w-full py-4 bg-green-600 text-white rounded-2xl font-black text-lg shadow-lg shadow-green-100">確定下單</button>
                <button onclick="hideConfirm()" class="w-full py-2 text-gray-400 font-bold text-sm">返回修改</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzg6nQRpwwgOkcIsPK-1RDmRBGHc6akdn95qH4q8ccvd53q5EPUfF47hufJcFJzhWNpGA/exec';
        let allOrders = [];
        let isDataLoading = false;

        window.onload = async () => {
            const saved = localStorage.getItem('u');
            if (saved) document.getElementById('userName').value = saved;
            await refreshData();
        };

        async function refreshData() {
            isDataLoading = true;
            showMenuLoadingState();
            showHistoryLoadingState();
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                allOrders = data.orders;
                renderMenu(data.menu);
            } catch (e) {
                console.error('載入失敗', e);
                showMenuErrorState();
                showHistoryErrorState();
                return;
            } finally {
                isDataLoading = false;
            }
            updateMyHistory();
        }

        function handleNameChange() {
            localStorage.setItem('u', document.getElementById('userName').value.trim());
            updateMyHistory();
        }

        function switchTab(tab) {
            const isOrder = tab === 'order';
            document.getElementById('sectionOrder').classList.toggle('hidden', !isOrder);
            document.getElementById('footerBar').classList.toggle('hidden', !isOrder);
            document.getElementById('sectionHistory').classList.toggle('hidden', isOrder);
            document.getElementById('tabOrder').className = isOrder ? 'flex-1 py-3 cursor-pointer active-tab' : 'flex-1 py-3 cursor-pointer';
            document.getElementById('tabHistory').className = !isOrder ? 'flex-1 py-3 cursor-pointer active-tab' : 'flex-1 py-3 cursor-pointer';
            if (!isOrder) updateMyHistory();
        }

        function showMenuLoadingState(message = '菜單載入中...') {
            const container = document.getElementById('menuContainer');
            container.innerHTML = `<div class="flex flex-col items-center justify-center py-16 text-gray-400 gap-3">
                <div class="loading-spinner"></div>
                <p class="text-xs font-bold tracking-widest uppercase text-gray-300">Loading</p>
                <p class="text-sm text-gray-500">${message}</p>
            </div>`;
        }

        function showMenuErrorState() {
            const container = document.getElementById('menuContainer');
            container.innerHTML = `<div class="flex flex-col items-center justify-center py-16 text-gray-400 gap-4">
                <div class="loading-spinner"></div>
                <p class="text-sm font-bold text-gray-600">菜單載入失敗</p>
                <button class="px-4 py-2 bg-green-600 text-white rounded-full text-xs font-black" onclick="refreshData()">重新整理</button>
            </div>`;
        }

        function showHistoryLoadingState(message = '紀錄載入中...') {
            const container = document.getElementById('myHistoryList');
            container.innerHTML = `<div class="flex flex-col items-center justify-center py-12 text-gray-400 gap-3">
                <div class="loading-spinner loading-spinner-sm"></div>
                <p class="text-xs font-bold tracking-widest uppercase text-gray-300">Loading</p>
                <p class="text-sm text-gray-500">${message}</p>
            </div>`;
        }

        function showHistoryErrorState() {
            const container = document.getElementById('myHistoryList');
            container.innerHTML = `<div class="flex flex-col items-center justify-center py-12 text-gray-500 gap-3">
                <div class="loading-spinner loading-spinner-sm"></div>
                <p class="text-sm font-bold">載入紀錄失敗</p>
                <button class="px-4 py-2 bg-green-600 text-white rounded-full text-xs font-black" onclick="refreshData()">重新整理</button>
            </div>`;
        }

        function renderMenu(items) {
            const container = document.getElementById('menuContainer');
            container.innerHTML = '';
            const groups = items.reduce((acc, i) => { (acc[i.category] = acc[i.category] || []).push(i); return acc; }, {});
            for (const [cat, list] of Object.entries(groups)) {
                let html = `<div class='mb-6'><h3 class='font-black text-gray-800 border-l-4 border-green-500 pl-3 mb-4'>${cat}</h3>`;
                list.forEach(i => {
                    html += `<div class='flex justify-between items-center mb-3 bg-white p-3 rounded-2xl border border-gray-100 shadow-sm transition-all'>
                        <span class='font-medium text-gray-600'>${i.name} <small class='text-gray-400 ml-1'>$${i.price}</small></span>
                        <input type="number" min="0" data-n="${i.name}" data-p="${i.price}" class="qty w-14 bg-gray-50 border-none rounded-xl text-center p-2 font-black text-green-700 outline-none" value="0" onchange="calc()">
                    </div>`;
                });
                container.innerHTML += html + `</div>`;
            }
        }

        function calc() {
            let t = 0;
            document.querySelectorAll('.qty').forEach(i => t += i.value * i.dataset.p);
            document.getElementById('totalPrice').innerText = t;
        }

        function updateMyHistory() {
            const name = document.getElementById('userName').value.trim();
            const container = document.getElementById('myHistoryList');
            if (isDataLoading) {
                showHistoryLoadingState();
                return;
            }
            if (!name) {
                container.innerHTML = '<div class="text-center py-20 text-gray-400 font-medium italic">請輸入姓名以讀取紀錄...</div>';
                return;
            }
            const myOrders = allOrders.filter(o => o['姓名'] === name);
            if (myOrders.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-gray-400 font-medium">找不到「${name}」的訂單紀錄</div>`;
                return;
            }
            const dates = ['1/28', '1/29'];
            let html = '';
            dates.forEach(d => {
                const dayOrders = myOrders.filter(o => o['日期'] === d);
                if (dayOrders.length > 0) {
                    let total = dayOrders.reduce((s, o) => s + parseInt(o['總額']), 0);
                    html += `<div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h4 class="font-black text-green-700 text-lg">${d} 早餐</h4>
                            <span class="text-xs font-bold bg-green-50 text-green-600 px-3 py-1 rounded-full">小計 $${total}</span>
                        </div>`;
                    dayOrders.forEach(o => {
                        html += `<div class="flex justify-between items-start mb-4 text-sm">
                            <div class="flex-1">
                                <div class="text-gray-800 font-bold">${o['品項']}</div>
                                <div class="text-[10px] text-gray-400 font-medium">
                                    單價 $${o['單價']} × 數量 ${o['數量']}
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="font-black text-gray-700">$${o['總額']}</span>
                                <button onclick="deleteOrder(${o.rowId})" class="text-red-200 hover:text-red-500 transition-colors p-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                }
            });
            container.innerHTML = html;
        }

        async function deleteOrder(rowId) {
            if (!confirm('確定要刪除這筆餐點嗎？')) return;
            document.getElementById('myHistoryList').style.opacity = '0.5';
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', rowId }) });
            await refreshData();
            document.getElementById('myHistoryList').style.opacity = '1';
        }

        function showConfirm() {
            const name = document.getElementById('userName').value.trim();
            const date = document.getElementById('orderDate').value;
            if (!name) return alert('請先輸入您的姓名');
            let listHtml = '';
            let hasItems = false;
            document.querySelectorAll('.qty').forEach(i => {
                if (i.value > 0) {
                    listHtml += `<div class="flex justify-between font-bold text-gray-700"><span>${i.dataset.n}</span><span class="text-green-600">x${i.value}</span></div>`;
                    hasItems = true;
                }
            });
            if (!hasItems) return alert('尚未選擇任何餐點');
            document.getElementById('confirmDate').innerText = (date === '1/28' ? '1月28日 (三)' : '1月29日 (四)');
            document.getElementById('confirmList').innerHTML = listHtml + `<div class="mt-4 pt-4 border-t-2 border-dashed flex justify-between font-black text-xl text-green-600"><span>總金額</span><span>$${document.getElementById('totalPrice').innerText}</span></div>`;
            document.getElementById('confirmModal').classList.replace('hidden', 'flex');
        }

        function hideConfirm() {
            document.getElementById('confirmModal').classList.replace('flex', 'hidden');
        }

        async function finalSubmit() {
            const btn = document.getElementById('finalBtn');
            const original = btn.dataset.defaultLabel || btn.innerHTML;
            btn.dataset.defaultLabel = original;
            btn.disabled = true;
            btn.innerHTML = `<div class="flex items-center justify-center gap-3">
                <div class="loading-spinner loading-spinner-sm"></div>
                <span>處理中...</span>
            </div>`;
            const orders = [];
            document.querySelectorAll('.qty').forEach(i => {
                if (i.value > 0) orders.push({ name: i.dataset.n, price: i.dataset.p, quantity: i.value });
            });
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ userName: document.getElementById('userName').value.trim(), date: document.getElementById('orderDate').value, orders, action: 'add' })});
            alert('點餐成功！');
            hideConfirm();
            document.querySelectorAll('.qty').forEach(i => i.value = 0);
            document.getElementById('totalPrice').innerText = '0';
            await refreshData();
            switchTab('history');
            btn.disabled = false;
            btn.innerHTML = btn.dataset.defaultLabel;
        }
    </script>
</body>
</html>
